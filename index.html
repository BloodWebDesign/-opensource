<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Змейка PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Заголовок */
        .header {
            text-align: center;
            padding: 30px 0;
            position: relative;
        }

        .logo {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #a9b7c6;
            margin-bottom: 30px;
        }

        /* Основное меню */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto 50px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #4cc9f0;
        }

        .menu-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(45deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .menu-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.5);
            background: linear-gradient(45deg, #3a0ca3, #4361ee);
        }

        .menu-btn.secondary {
            background: linear-gradient(45deg, #f72585, #b5179e);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
        }

        .menu-btn.secondary:hover {
            box-shadow: 0 8px 20px rgba(247, 37, 133, 0.5);
            background: linear-gradient(45deg, #b5179e, #f72585);
        }

        /* Игровое поле */
        .game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-container {
            display: flex;
            gap: 30px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4cc9f0;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #a9b7c6;
        }

        .game-area {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        #game-canvas {
            background-color: #0d1b2a;
            display: block;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .mobile-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .mobile-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            user-select: none;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .mobile-btn.up {
            grid-column: 2;
            grid-row: 1;
        }

        .mobile-btn.left {
            grid-column: 1;
            grid-row: 2;
        }

        .mobile-btn.right {
            grid-column: 3;
            grid-row: 2;
        }

        .mobile-btn.down {
            grid-column: 2;
            grid-row: 2;
        }

        .mobile-btn.action {
            grid-column: 1 / span 3;
            grid-row: 3;
            width: 100%;
            border-radius: 15px;
            background: rgba(76, 201, 240, 0.2);
        }

        /* Окна настроек, рекордов и информации */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8rem;
            color: #4cc9f0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #f72585;
            cursor: pointer;
        }

        /* Настройки */
        .settings-option {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #4cc9f0;
        }

        input[type="range"] {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #4cc9f0;
        }

        /* Таблица рекордов */
        .highscores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .highscores-table th {
            background: rgba(76, 201, 240, 0.2);
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .highscores-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .highscores-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Игровые сообщения */
        .game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 30px 50px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            display: none;
            border: 2px solid #4cc9f0;
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.5);
        }

        .message-title {
            font-size: 2.5rem;
            color: #f72585;
            margin-bottom: 15px;
        }

        .message-text {
            font-size: 1.2rem;
            margin-bottom: 25px;
        }

        /* Игровые элементы */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .food-color {
            background: #f72585;
        }

        .bonus-color {
            background: #ffd166;
        }

        .poison-color {
            background: #06d6a0;
        }

        .portal-color {
            background: #9d4edd;
        }

        .speed-color {
            background: #ff9e00;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.5rem;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .stats-container {
                justify-content: center;
            }
            
            .mobile-controls {
                display: grid;
            }
            
            .controls-info {
                text-align: center;
                margin-top: 20px;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 2rem;
            }
            
            .menu-btn {
                padding: 15px;
                font-size: 1rem;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* Анимации */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes foodGlow {
            0% { opacity: 0.7; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.7; transform: scale(0.95); }
        }

        /* Скроллбар */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #4361ee, #3a0ca3);
            border-radius: 10px;
        }

        /* Эффекты частиц */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>
    <!-- Эффект частиц -->
    <canvas class="particles" id="particles"></canvas>
    
    <div class="container">
        <!-- Главное меню -->
        <div class="header">
            <div class="logo">ЗМЕЙКА PRO</div>
            <div class="subtitle">Продвинутая версия с уникальными возможностями и режимами</div>
        </div>

        <div class="main-menu" id="main-menu">
            <h2 class="menu-title">ГЛАВНОЕ МЕНЮ</h2>
            <button class="menu-btn" id="start-game-btn">
                <i class="fas fa-play-circle"></i> НАЧАТЬ ИГРУ
            </button>
            <button class="menu-btn secondary" id="classic-mode-btn">
                <i class="fas fa-history"></i> КЛАССИЧЕСКИЙ РЕЖИМ
            </button>
            <button class="menu-btn secondary" id="settings-btn">
                <i class="fas fa-cog"></i> НАСТРОЙКИ
            </button>
            <button class="menu-btn secondary" id="highscores-btn">
                <i class="fas fa-trophy"></i> РЕКОРДЫ
            </button>
            <button class="menu-btn secondary" id="about-btn">
                <i class="fas fa-info-circle"></i> ОБ ИГРЕ
            </button>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color food-color"></div>
                    <span>Еда (+10 очков)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color bonus-color"></div>
                    <span>Бонус (+50 очков)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color poison-color"></div>
                    <span>Яд (минус жизнь)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color portal-color"></div>
                    <span>Телепорт</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color speed-color"></div>
                    <span>Ускорение</span>
                </div>
            </div>
        </div>

        <!-- Игровая область -->
        <div class="game-container" id="game-container">
            <div class="game-header">
                <div class="stats-container">
                    <div class="stat">
                        <div class="stat-value" id="score">0</div>
                        <div class="stat-label">СЧЁТ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="level">1</div>
                        <div class="stat-label">УРОВЕНЬ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="lives">3</div>
                        <div class="stat-label">ЖИЗНИ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="high-score">0</div>
                        <div class="stat-label">РЕКОРД</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="length">3</div>
                        <div class="stat-label">ДЛИНА</div>
                    </div>
                </div>
                <button class="menu-btn" id="pause-btn" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-pause"></i> ПАУЗА
                </button>
            </div>

            <div class="game-area">
                <canvas id="game-canvas" width="800" height="500"></canvas>
                <div class="game-message" id="game-message">
                    <div class="message-title" id="message-title">ПАУЗА</div>
                    <div class="message-text" id="message-text">Игра приостановлена</div>
                    <button class="menu-btn" id="resume-btn">
                        <i class="fas fa-play"></i> ПРОДОЛЖИТЬ
                    </button>
                </div>
            </div>

            <div class="controls">
                <p>Управление: <strong>WASD</strong> или <strong>Стрелки</strong> для движения</p>
                <p>Пробел - пауза | R - рестарт</p>
                
                <div class="mobile-controls">
                    <div class="mobile-btn up" id="mobile-up"><i class="fas fa-arrow-up"></i></div>
                    <div class="mobile-btn left" id="mobile-left"><i class="fas fa-arrow-left"></i></div>
                    <div class="mobile-btn down" id="mobile-down"><i class="fas fa-arrow-down"></i></div>
                    <div class="mobile-btn right" id="mobile-right"><i class="fas fa-arrow-right"></i></div>
                    <button class="mobile-btn action" id="mobile-portal"><i class="fas fa-bolt"></i> ТЕЛЕПОРТ</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно настроек -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-cog"></i> НАСТРОЙКИ ИГРЫ</h2>
                    <button class="close-modal" id="close-settings">&times;</button>
                </div>
                
                <div class="settings-option">
                    <label class="settings-label">Скорость игры</label>
                    <div class="slider-container">
                        <span class="slider-value" id="speed-value">3</span>
                        <input type="range" id="speed-slider" min="1" max="5" value="3">
                    </div>
                </div>
                
                <div class="settings-option">
                    <label class="settings-label">Сложность</label>
                    <div class="slider-container">
                        <span class="slider-value" id="difficulty-value">2</span>
                        <input type="range" id="difficulty-slider" min="1" max="3" value="2">
                    </div>
                </div>
                
                <div class="settings-option">
                    <div class="checkbox-container">
                        <input type="checkbox" id="sound-toggle" checked>
                        <label class="settings-label">Звуковые эффекты</label>
                    </div>
                </div>
                
                <div class="settings-option">
                    <div class="checkbox-container">
                        <input type="checkbox" id="wall-toggle" checked>
                        <label class="settings-label">Сквозные стены</label>
                    </div>
                </div>
                
                <div class="settings-option">
                    <div class="checkbox-container">
                        <input type="checkbox" id="bonus-toggle" checked>
                        <label class="settings-label">Случайные бонусы</label>
                    </div>
                </div>
                
                <div class="settings-option">
                    <div class="checkbox-container">
                        <input type="checkbox" id="particles-toggle" checked>
                        <label class="settings-label">Эффекты частиц</label>
                    </div>
                </div>
                
                <button class="menu-btn" id="save-settings">
                    <i class="fas fa-save"></i> СОХРАНИТЬ НАСТРОЙКИ
                </button>
            </div>
        </div>

        <!-- Модальное окно рекордов -->
        <div class="modal" id="highscores-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-trophy"></i> ТАБЛИЦА РЕКОРДОВ</h2>
                    <button class="close-modal" id="close-highscores">&times;</button>
                </div>
                
                <table class="highscores-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Игрок</th>
                            <th>Счёт</th>
                            <th>Уровень</th>
                            <th>Длина</th>
                            <th>Дата</th>
                        </tr>
                    </thead>
                    <tbody id="highscores-body">
                    </tbody>
                </table>
                
                <button class="menu-btn secondary" id="clear-highscores" style="margin-top: 20px;">
                    <i class="fas fa-trash-alt"></i> ОЧИСТИТЬ РЕКОРДЫ
                </button>
            </div>
        </div>

        <!-- Модальное окно информации об игре -->
        <div class="modal" id="about-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-info-circle"></i> ОБ ИГРЕ "ЗМЕЙКА PRO MAX"</h2>
                    <button class="close-modal" id="close-about">&times;</button>
                </div>
                
                <div style="line-height: 1.6;">
                    <h3 style="color: #4cc9f0; margin: 20px 0 10px;">Уникальные особенности:</h3>
                    <ul style="padding-left: 20px; margin-bottom: 20px;">
                        <li><strong>Два режима игры</strong> - классический и расширенный</li>
                        <li><strong>Многоуровневая система</strong> - с каждым уровнем игра становится сложнее</li>
                        <li><strong>Разные типы еды</strong> - обычная еда, бонусы, яд, телепорты и ускорения</li>
                        <li><strong>Система жизней</strong> - у вас есть 3 жизни для прохождения игры</li>
                        <li><strong>Телепорты и ускорения</strong> - специальные возможности</li>
                        <li><strong>Динамические препятствия</strong> - появляются на высоких уровнях</li>
                        <li><strong>Локальные рекорды</strong> - таблица лучших результатов</li>
                        <li><strong>Эффекты частиц</strong> - красивый визуальный эффект</li>
                    </ul>
                    
                    <h3 style="color: #4cc9f0; margin: 20px 0 10px;">Управление:</h3>
                    <ul style="padding-left: 20px; margin-bottom: 20px;">
                        <li><strong>W, A, S, D</strong> или <strong>Стрелки</strong> - движение змейки</li>
                        <li><strong>Пробел</strong> - пауза/продолжить игру</li>
                        <li><strong>P</strong> - активировать телепорт (если доступен)</li>
                        <li><strong>S</strong> - замедление времени на 3 секунды</li>
                        <li><strong>R</strong> - перезапустить игру</li>
                        <li><strong>ESC</strong> - выход в главное меню</li>
                    </ul>
                    
                    <h3 style="color: #4cc9f0; margin: 20px 0 10px;">Игровые элементы:</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 15px; height: 15px; background: #f72585; border-radius: 3px;"></div>
                            <span>Еда (+10 очков)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 15px; height: 15px; background: #ffd166; border-radius: 3px;"></div>
                            <span>Бонус (+50 очков)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 15px; height: 15px; background: #06d6a0; border-radius: 3px;"></div>
                            <span>Яд (минус жизнь)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 15px; height: 15px; background: #9d4edd; border-radius: 3px;"></div>
                            <span>Телепорт</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div style="width: 15px; height: 15px; background: #ff9e00; border-radius: 3px;"></div>
                            <span>Ускорение</span>
                        </div>
                    </div>
                    
                    <p style="font-style: italic; color: #a9b7c6; text-align: center; margin-top: 25px;">
                        Игра разработана с использованием HTML5 Canvas и JavaScript
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Игровые переменные
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCountX = canvas.width / gridSize;
        const tileCountY = canvas.height / gridSize;
        
        let snake = [];
        let food = {x: 15, y: 10, type: 'normal'};
        let bonus = null;
        let poison = null;
        let portal = null;
        let speedBoost = null;
        let obstacles = [];
        
        let dx = 0;
        let dy = 0;
        let score = 0;
        let level = 1;
        let lives = 3;
        let highScore = localStorage.getItem('snakeHighScore') || 0;
        let gameSpeed = 10;
        let baseSpeed = 10;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoop;
        let directionChanged = false;
        let slowMotionActive = false;
        let slowMotionTimer = 0;
        let isClassicMode = false;
        let particlesEnabled = true;
        
        // Настройки игры
        let settings = {
            speed: 3,
            difficulty: 2,
            sound: true,
            wallPass: true,
            bonuses: true,
            particles: true
        };
        
        // Загрузка настроек из localStorage
        if (localStorage.getItem('snakeSettings')) {
            settings = JSON.parse(localStorage.getItem('snakeSettings'));
        }
        
        // Загрузка рекордов из localStorage
        let highscores = JSON.parse(localStorage.getItem('snakeHighscores')) || [];
        
        // Элементы DOM
        const mainMenu = document.getElementById('main-menu');
        const gameContainer = document.getElementById('game-container');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const livesElement = document.getElementById('lives');
        const highScoreElement = document.getElementById('high-score');
        const lengthElement = document.getElementById('length');
        const gameMessage = document.getElementById('game-message');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        
        // Система частиц
        let particles = [];
        
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 3 - 1.5;
                this.speedY = Math.random() * 3 - 1.5;
                this.life = 30;
            }
            
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life--;
                this.size *= 0.95;
            }
            
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.life / 30;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
        
        // Инициализация игры
        function initGame(classicMode = false) {
            isClassicMode = classicMode;
            
            // Создание змейки
            snake = [
                {x: 10, y: 10},
                {x: 9, y: 10},
                {x: 8, y: 10}
            ];
            
            // Сброс направления
            dx = 1;
            dy = 0;
            
            // Сброс счета и уровня
            score = 0;
            level = 1;
            lives = 3;
            
            // Сброс эффектов
            slowMotionActive = false;
            slowMotionTimer = 0;
            
            // Генерация первой еды - ИСПРАВЛЕНИЕ: гарантированное создание еды
            generateFood();
            
            // Очистка бонусов и препятствий
            bonus = null;
            poison = null;
            portal = null;
            speedBoost = null;
            obstacles = [];
            
            // В классическом режиме отключаем бонусы и препятствия
            if (classicMode) {
                obstacles = [];
            } else if (level > 1) {
                generateObstacles();
            }
            
            // Обновление отображения
            updateUI();
            
            // Настройка скорости в зависимости от уровня сложности
            updateGameSpeed();
        }
        
        // Генерация еды - ИСПРАВЛЕННЫЙ МЕТОД
        function generateFood() {
            let newFood;
            let validPosition = false;
            let attempts = 0;
            
            while (!validPosition && attempts < 100) {
                newFood = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    type: 'normal'
                };
                
                // Проверяем, чтобы еда не появилась на змейке
                validPosition = !snake.some(segment => segment.x === newFood.x && segment.y === newFood.y);
                
                // Проверяем, чтобы еда не появилась на препятствиях
                if (validPosition && obstacles.length > 0) {
                    validPosition = !obstacles.some(obs => obs.x === newFood.x && obs.y === newFood.y);
                }
                
                attempts++;
            }
            
            // Если не нашли валидную позицию, ищем более простым способом
            if (!validPosition) {
                console.log("Используем альтернативный метод генерации еды");
                // Простой перебор всех возможных позиций
                for (let y = 0; y < tileCountY; y++) {
                    for (let x = 0; x < tileCountX; x++) {
                        let possible = true;
                        
                        // Проверяем, чтобы позиция была свободна
                        for (let segment of snake) {
                            if (segment.x === x && segment.y === y) {
                                possible = false;
                                break;
                            }
                        }
                        
                        if (possible && obstacles.length > 0) {
                            for (let obs of obstacles) {
                                if (obs.x === x && obs.y === y) {
                                    possible = false;
                                    break;
                                }
                            }
                        }
                        
                        if (possible) {
                            food = {x: x, y: y, type: 'normal'};
                            console.log("Еда создана на позиции:", x, y);
                            return;
                        }
                    }
                }
            } else {
                food = newFood;
                console.log("Еда создана на позиции:", newFood.x, newFood.y);
            }
            
            // С шансом генерируем специальные предметы (только в неклассическом режиме)
            if (!isClassicMode && settings.bonuses) {
                // 20% шанс на бонус
                if (Math.random() < 0.2 && bonus === null) {
                    generateBonus();
                }
                
                // 10% шанс на яд на уровнях выше 2
                if (level > 2 && Math.random() < 0.1 && poison === null) {
                    generatePoison();
                }
                
                // 15% шанс на телепорт на уровнях выше 3
                if (level > 3 && Math.random() < 0.15 && portal === null) {
                    generatePortal();
                }
                
                // 10% шанс на ускорение на уровнях выше 4
                if (level > 4 && Math.random() < 0.1 && speedBoost === null) {
                    generateSpeedBoost();
                }
            }
        }
        
        // Генерация бонуса
        function generateBonus() {
            let newBonus;
            let validPosition = false;
            let attempts = 0;
            
            while (!validPosition && attempts < 50) {
                newBonus = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    timer: 100 // Бонус существует 100 кадров
                };
                
                validPosition = !snake.some(segment => segment.x === newBonus.x && segment.y === newBonus.y) &&
                               !(food.x === newBonus.x && food.y === newBonus.y) &&
                               !obstacles.some(obs => obs.x === newBonus.x && obs.y === newBonus.y);
                attempts++;
            }
            
            if (validPosition) {
                bonus = newBonus;
            }
        }
        
        // Генерация яда
        function generatePoison() {
            let newPoison;
            let validPosition = false;
            let attempts = 0;
            
            while (!validPosition && attempts < 50) {
                newPoison = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    timer: 150 // Яд существует 150 кадров
                };
                
                validPosition = !snake.some(segment => segment.x === newPoison.x && segment.y === newPoison.y) &&
                               !(food.x === newPoison.x && food.y === newPoison.y) &&
                               (!bonus || !(bonus.x === newPoison.x && bonus.y === newPoison.y)) &&
                               !obstacles.some(obs => obs.x === newPoison.x && obs.y === newPoison.y);
                attempts++;
            }
            
            if (validPosition) {
                poison = newPoison;
            }
        }
        
        // Генерация телепорта
        function generatePortal() {
            let newPortal;
            let validPosition = false;
            let attempts = 0;
            
            while (!validPosition && attempts < 50) {
                newPortal = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    active: true
                };
                
                validPosition = !snake.some(segment => segment.x === newPortal.x && segment.y === newPortal.y) &&
                               !(food.x === newPortal.x && food.y === newPortal.y) &&
                               (!bonus || !(bonus.x === newPortal.x && bonus.y === newPortal.y)) &&
                               (!poison || !(poison.x === newPortal.x && poison.y === newPortal.y)) &&
                               !obstacles.some(obs => obs.x === newPortal.x && obs.y === newPortal.y);
                attempts++;
            }
            
            if (validPosition) {
                portal = newPortal;
            }
        }
        
        // Генерация ускорения
        function generateSpeedBoost() {
            let newSpeedBoost;
            let validPosition = false;
            let attempts = 0;
            
            while (!validPosition && attempts < 50) {
                newSpeedBoost = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY),
                    timer: 80 // Ускорение существует 80 кадров
                };
                
                validPosition = !snake.some(segment => segment.x === newSpeedBoost.x && segment.y === newSpeedBoost.y) &&
                               !(food.x === newSpeedBoost.x && food.y === newSpeedBoost.y) &&
                               (!bonus || !(bonus.x === newSpeedBoost.x && bonus.y === newSpeedBoost.y)) &&
                               (!poison || !(poison.x === newSpeedBoost.x && poison.y === newSpeedBoost.y)) &&
                               (!portal || !(portal.x === newSpeedBoost.x && portal.y === newSpeedBoost.y)) &&
                               !obstacles.some(obs => obs.x === newSpeedBoost.x && obs.y === newSpeedBoost.y);
                attempts++;
            }
            
            if (validPosition) {
                speedBoost = newSpeedBoost;
            }
        }
        
        // Генерация препятствий для уровня
        function generateObstacles() {
            if (isClassicMode) return;
            
            obstacles = [];
            const obstacleCount = Math.min(level + 2, 15); // Максимум 15 препятствий
            
            for (let i = 0; i < obstacleCount; i++) {
                let newObstacle;
                let validPosition = false;
                let attempts = 0;
                
                while (!validPosition && attempts < 50) {
                    newObstacle = {
                        x: Math.floor(Math.random() * tileCountX),
                        y: Math.floor(Math.random() * tileCountY)
                    };
                    
                    // Проверяем, чтобы препятствие не появилось в центральной зоне
                    const isInCenter = (
                        newObstacle.x >= tileCountX/2 - 3 && 
                        newObstacle.x <= tileCountX/2 + 3 &&
                        newObstacle.y >= tileCountY/2 - 3 && 
                        newObstacle.y <= tileCountY/2 + 3
                    );
                    
                    // Проверяем, чтобы препятствие не появилось на змейке, еде или других объектах
                    validPosition = !isInCenter &&
                                   !snake.some(segment => segment.x === newObstacle.x && segment.y === newObstacle.y) &&
                                   !(food.x === newObstacle.x && food.y === newObstacle.y) &&
                                   (!bonus || !(bonus.x === newObstacle.x && bonus.y === newObstacle.y)) &&
                                   (!poison || !(poison.x === newObstacle.x && poison.y === newObstacle.y)) &&
                                   (!portal || !(portal.x === newObstacle.x && portal.y === newObstacle.y)) &&
                                   (!speedBoost || !(speedBoost.x === newObstacle.x && speedBoost.y === newObstacle.y)) &&
                                   !obstacles.some(obs => obs.x === newObstacle.x && obs.y === newObstacle.y);
                    attempts++;
                }
                
                if (validPosition) {
                    obstacles.push(newObstacle);
                }
            }
        }
        
        // Обновление игровой скорости
        function updateGameSpeed() {
            baseSpeed = 15 - (settings.speed * 2) - Math.floor(level / 2);
            if (baseSpeed < 5) baseSpeed = 5;
            
            // Применяем замедление если активно
            gameSpeed = slowMotionActive ? baseSpeed * 2 : baseSpeed;
        }
        
        // Активация замедления
        function activateSlowMotion() {
            if (slowMotionActive) return;
            
            slowMotionActive = true;
            slowMotionTimer = 90; // 3 секунды при 30 FPS
            updateGameSpeed();
            
            // Перезапускаем игровой цикл с новой скоростью
            clearInterval(gameLoop);
            gameLoop = setInterval(gameUpdate, 1000 / gameSpeed);
            
            // Создаем эффект частиц
            createParticleEffect(snake[0].x * gridSize + gridSize/2, snake[0].y * gridSize + gridSize/2, '#4cc9f0');
        }
        
        // Создание эффекта частиц
        function createParticleEffect(x, y, color) {
            if (!particlesEnabled) return;
            
            for (let i = 0; i < 15; i++) {
                particles.push(new Particle(x, y, color));
            }
        }
        
        // Основной игровой цикл
        function gameUpdate() {
            if (gamePaused || !gameRunning) return;
            
            directionChanged = false;
            
            // Обновляем таймер замедления
            if (slowMotionActive) {
                slowMotionTimer--;
                if (slowMotionTimer <= 0) {
                    slowMotionActive = false;
                    updateGameSpeed();
                    clearInterval(gameLoop);
                    gameLoop = setInterval(gameUpdate, 1000 / gameSpeed);
                }
            }
            
            // Перемещение змейки
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            
            // Проверка на выход за границы
            if (settings.wallPass) {
                if (head.x < 0) head.x = tileCountX - 1;
                if (head.x >= tileCountX) head.x = 0;
                if (head.y < 0) head.y = tileCountY - 1;
                if (head.y >= tileCountY) head.y = 0;
            } else {
                // Стены смертельны
                if (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY) {
                    loseLife();
                    return;
                }
            }
            
            // Проверка на столкновение с собой
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                loseLife();
                return;
            }
            
            // Проверка на столкновение с препятствиями
            if (obstacles.some(obs => obs.x === head.x && obs.y === head.y)) {
                loseLife();
                return;
            }
            
            // Добавление новой головы
            snake.unshift(head);
            
            // Проверка на сбор еды - ИСПРАВЛЕННАЯ ПРОВЕРКА
            let ateFood = false;
            
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                ateFood = true;
                createParticleEffect(food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2, '#f72585');
                
                // Каждые 50 очков повышаем уровень
                if (score % 50 === 0) {
                    levelUp();
                }
                
                generateFood();
            } else if (bonus && head.x === bonus.x && head.y === bonus.y) {
                // Сбор бонуса
                score += 50;
                createParticleEffect(bonus.x * gridSize + gridSize/2, bonus.y * gridSize + gridSize/2, '#ffd166');
                bonus = null;
            } else if (poison && head.x === poison.x && head.y === poison.y) {
                // Сбор яда
                lives--;
                createParticleEffect(poison.x * gridSize + gridSize/2, poison.y * gridSize + gridSize/2, '#06d6a0');
                poison = null;
                updateUI();
                
                if (lives <= 0) {
                    gameOver();
                    return;
                }
            } else if (portal && head.x === portal.x && head.y === portal.y && portal.active) {
                // Активация телепорта
                createParticleEffect(portal.x * gridSize + gridSize/2, portal.y * gridSize + gridSize/2, '#9d4edd');
                teleportSnake();
                portal.active = false;
            } else if (speedBoost && head.x === speedBoost.x && head.y === speedBoost.y) {
                // Сбор ускорения
                activateSlowMotion();
                createParticleEffect(speedBoost.x * gridSize + gridSize/2, speedBoost.y * gridSize + gridSize/2, '#ff9e00');
                speedBoost = null;
            } else {
                // Удаление хвоста, если ничего не собрали
                snake.pop();
            }
            
            // Обновление таймеров бонусов и яда
            if (bonus) {
                bonus.timer--;
                if (bonus.timer <= 0) {
                    bonus = null;
                }
            }
            
            if (poison) {
                poison.timer--;
                if (poison.timer <= 0) {
                    poison = null;
                }
            }
            
            if (speedBoost) {
                speedBoost.timer--;
                if (speedBoost.timer <= 0) {
                    speedBoost = null;
                }
            }
            
            // Обновляем частицы
            if (particlesEnabled) {
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    if (particles[i].life <= 0) {
                        particles.splice(i, 1);
                    }
                }
            }
            
            updateUI();
            draw();
        }
        
        // Повышение уровня
        function levelUp() {
            level++;
            updateGameSpeed();
            
            // Генерация препятствий для нового уровня
            if (!isClassicMode) {
                generateObstacles();
            }
            
            // Уведомление о новом уровне
            showMessage(`УРОВЕНЬ ${level}!`, `Скорость увеличена!`);
            
            // Обновление скорости игры
            clearInterval(gameLoop);
            gameLoop = setInterval(gameUpdate, 1000 / gameSpeed);
        }
        
        // Потеря жизни
        function loseLife() {
            lives--;
            updateUI();
            
            if (lives <= 0) {
                gameOver();
            } else {
                // Сброс змейки в центр
                snake = [
                    {x: 10, y: 10},
                    {x: 9, y: 10},
                    {x: 8, y: 10}
                ];
                
                dx = 1;
                dy = 0;
                
                // Очищаем препятствия в классическом режиме
                if (isClassicMode) {
                    obstacles = [];
                }
                
                showMessage("ПОТЕРЯНА ЖИЗНЬ!", `Осталось жизней: ${lives}`);
            }
        }
        
        // Телепорт змейки
        function teleportSnake() {
            let newHead;
            let validPosition = false;
            let attempts = 0;
            
            // Ищем новую позицию для головы
            while (!validPosition && attempts < 100) {
                newHead = {
                    x: Math.floor(Math.random() * tileCountX),
                    y: Math.floor(Math.random() * tileCountY)
                };
                
                validPosition = !snake.some(segment => segment.x === newHead.x && segment.y === newHead.y) &&
                               !obstacles.some(obs => obs.x === newHead.x && obs.y === newHead.y);
                attempts++;
            }
            
            // Если не нашли валидную позицию, используем центр
            if (!validPosition) {
                newHead = {x: Math.floor(tileCountX/2), y: Math.floor(tileCountY/2)};
            }
            
            // Перемещаем змейку
            const offsetX = newHead.x - snake[0].x;
            const offsetY = newHead.y - snake[0].y;
            
            for (let i = 0; i < snake.length; i++) {
                snake[i].x += offsetX;
                snake[i].y += offsetY;
                
                // Корректировка позиции при выходе за границы
                if (snake[i].x < 0) snake[i].x = tileCountX - 1;
                if (snake[i].x >= tileCountX) snake[i].x = 0;
                if (snake[i].y < 0) snake[i].y = tileCountY - 1;
                if (snake[i].y >= tileCountY) snake[i].y = 0;
            }
            
            // Создаем эффект телепортации
            for (let i = 0; i < 30; i++) {
                particles.push(new Particle(
                    newHead.x * gridSize + gridSize/2,
                    newHead.y * gridSize + gridSize/2,
                    '#9d4edd'
                ));
            }
            
            showMessage("ТЕЛЕПОРТАЦИЯ!", "Змейка перемещена!");
        }
        
        // Конец игры
        function gameOver() {
            gameRunning = false;
            clearInterval(gameLoop);
            
            // Сохранение рекорда
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeHighScore', highScore);
                
                // Добавление в таблицу рекордов
                addHighscore(score, level, snake.length);
            }
            
            showMessage("ИГРА ОКОНЧЕНА", `Ваш счёт: ${score}`, true);
        }
        
        // Добавление рекорда
        function addHighscore(score, level, length) {
            const playerName = prompt("Новый рекорд! Введите ваше имя:", "Игрок");
            
            if (playerName) {
                const newScore = {
                    name: playerName.substring(0, 20),
                    score: score,
                    level: level,
                    length: length,
                    date: new Date().toLocaleDateString(),
                    mode: isClassicMode ? 'Классический' : 'Расширенный'
                };
                
                highscores.push(newScore);
                highscores.sort((a, b) => b.score - a.score);
                
                if (highscores.length > 10) {
                    highscores = highscores.slice(0, 10);
                }
                
                localStorage.setItem('snakeHighscores', JSON.stringify(highscores));
                updateHighscoresTable();
            }
        }
        
        // Обновление таблицы рекордов
        function updateHighscoresTable() {
            const highscoresBody = document.getElementById('highscores-body');
            highscoresBody.innerHTML = '';
            
            if (highscores.length === 0) {
                highscoresBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px;">
                            Рекордов пока нет. Сыграйте и установите первый рекорд!
                        </td>
                    </tr>
                `;
                return;
            }
            
            highscores.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${record.name}</td>
                    <td>${record.score}</td>
                    <td>${record.level}</td>
                    <td>${record.length}</td>
                    <td>${record.date}</td>
                `;
                highscoresBody.appendChild(row);
            });
        }
        
        // Отображение сообщения
        function showMessage(title, text, isGameOver = false) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            gameMessage.style.display = 'block';
            
            // Для игрового овер показываем кнопку "Меню", а не "Продолжить"
            if (isGameOver) {
                document.getElementById('resume-btn').innerHTML = '<i class="fas fa-home"></i> В ГЛАВНОЕ МЕНЮ';
                document.getElementById('resume-btn').onclick = () => {
                    gameMessage.style.display = 'none';
                    gameContainer.style.display = 'none';
                    mainMenu.style.display = 'flex';
                };
            } else {
                document.getElementById('resume-btn').innerHTML = '<i class="fas fa-play"></i> ПРОДОЛЖИТЬ';
                document.getElementById('resume-btn').onclick = () => {
                    gameMessage.style.display = 'none';
                    if (gameRunning) {
                        togglePause();
                    }
                };
            }
        }
        
        // Пауза игры
        function togglePause() {
            gamePaused = !gamePaused;
            
            if (gamePaused) {
                showMessage("ПАУЗА", "Игра приостановлена");
            } else {
                gameMessage.style.display = 'none';
            }
        }
        
        // Обновление интерфейса
        function updateUI() {
            scoreElement.textContent = score;
            levelElement.textContent = level;
            livesElement.textContent = lives;
            highScoreElement.textContent = highScore;
            lengthElement.textContent = snake.length;
        }
        
        // Отрисовка игры - ИСПРАВЛЕННАЯ ФУНКЦИЯ
        function draw() {
            // Очистка холста
            ctx.fillStyle = '#0d1b2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Отрисовка сетки (только на первых уровнях)
            if (level < 5) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
                ctx.lineWidth = 1;
                
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
            
            // Отрисовка препятствий
            ctx.fillStyle = '#415a77';
            obstacles.forEach(obs => {
                ctx.fillRect(obs.x * gridSize, obs.y * gridSize, gridSize - 1, gridSize - 1);
                
                // Добавляем текстуру препятствиям
                ctx.fillStyle = '#1b263b';
                ctx.fillRect(obs.x * gridSize + 2, obs.y * gridSize + 2, gridSize - 5, gridSize - 5);
                ctx.fillStyle = '#415a77';
            });
            
            // Отрисовка еды - ИСПРАВЛЕННАЯ ОТРИСОВКА
            if (food) {
                // Анимация пульсации для еды
                const pulseScale = 0.9 + 0.1 * Math.sin(Date.now() / 200);
                
                ctx.save();
                ctx.translate(
                    food.x * gridSize + gridSize / 2,
                    food.y * gridSize + gridSize / 2
                );
                ctx.scale(pulseScale, pulseScale);
                
                // Основной круг еды
                ctx.fillStyle = '#f72585';
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 2 - 1, 0, Math.PI * 2);
                ctx.fill();
                
                // Внутренний круг для объема
                ctx.fillStyle = '#ff4da6';
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Блики
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(-gridSize/6, -gridSize/6, gridSize/8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Свечение вокруг еды
                ctx.shadowColor = '#f72585';
                ctx.shadowBlur = 10;
                ctx.fillStyle = '#f72585';
                ctx.beginPath();
                ctx.arc(
                    food.x * gridSize + gridSize / 2,
                    food.y * gridSize + gridSize / 2,
                    gridSize / 2 + 2,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            // Отрисовка бонуса
            if (bonus) {
                const pulseScale = 0.9 + 0.1 * Math.sin(Date.now() / 150);
                
                ctx.save();
                ctx.translate(
                    bonus.x * gridSize + gridSize / 2,
                    bonus.y * gridSize + gridSize / 2
                );
                ctx.scale(pulseScale, pulseScale);
                
                // Звезда бонуса
                ctx.fillStyle = '#ffd166';
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * 2 * Math.PI) / 5 - Math.PI / 2;
                    const radius1 = gridSize / 2 - 2;
                    const radius2 = gridSize / 4;
                    
                    if (i === 0) {
                        ctx.moveTo(
                            Math.cos(angle) * radius1,
                            Math.sin(angle) * radius1
                        );
                    } else {
                        ctx.lineTo(
                            Math.cos(angle) * radius1,
                            Math.sin(angle) * radius1
                        );
                    }
                    
                    const nextAngle = angle + Math.PI / 5;
                    ctx.lineTo(
                        Math.cos(nextAngle) * radius2,
                        Math.sin(nextAngle) * radius2
                    );
                }
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
                
                // Свечение
                ctx.shadowColor = '#ffd166';
                ctx.shadowBlur = 15;
                ctx.fillStyle = '#ffd166';
                ctx.beginPath();
                ctx.arc(
                    bonus.x * gridSize + gridSize / 2,
                    bonus.y * gridSize + gridSize / 2,
                    gridSize / 2 + 3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            // Отрисовка яда
            if (poison) {
                const rotation = Date.now() / 1000;
                
                ctx.save();
                ctx.translate(
                    poison.x * gridSize + gridSize / 2,
                    poison.y * gridSize + gridSize / 2
                );
                ctx.rotate(rotation);
                
                // Череп яда
                ctx.fillStyle = '#06d6a0';
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 2 - 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Глазницы
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-gridSize/4, -gridSize/8, gridSize/6, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(gridSize/4, -gridSize/8, gridSize/6, 0, Math.PI * 2);
                ctx.fill();
                
                // Улыбка
                ctx.beginPath();
                ctx.arc(0, gridSize/8, gridSize/4, 0, Math.PI);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.restore();
            }
            
            // Отрисовка телепорта
            if (portal && portal.active) {
                const rotation = Date.now() / 500;
                
                ctx.save();
                ctx.translate(
                    portal.x * gridSize + gridSize / 2,
                    portal.y * gridSize + gridSize / 2
                );
                ctx.rotate(rotation);
                
                // Внешнее кольцо
                ctx.strokeStyle = '#9d4edd';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 2 + 2, 0, Math.PI * 2);
                ctx.stroke();
                
                // Внутреннее кольцо
                ctx.strokeStyle = '#c77dff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 2 - 2, 0, Math.PI * 2);
                ctx.stroke();
                
                // Центр
                ctx.fillStyle = '#9d4edd';
                ctx.beginPath();
                ctx.arc(0, 0, gridSize / 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Свечение
                ctx.shadowColor = '#9d4edd';
                ctx.shadowBlur = 20;
                ctx.fillStyle = '#9d4edd';
                ctx.beginPath();
                ctx.arc(
                    portal.x * gridSize + gridSize / 2,
                    portal.y * gridSize + gridSize / 2,
                    gridSize / 2 + 5,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            // Отрисовка ускорения
            if (speedBoost) {
                const pulseScale = 0.8 + 0.2 * Math.sin(Date.now() / 100);
                
                ctx.save();
                ctx.translate(
                    speedBoost.x * gridSize + gridSize / 2,
                    speedBoost.y * gridSize + gridSize / 2
                );
                ctx.scale(pulseScale, pulseScale);
                
                // Молния
                ctx.fillStyle = '#ff9e00';
                ctx.beginPath();
                ctx.moveTo(-gridSize/3, gridSize/3);
                ctx.lineTo(0, -gridSize/3);
                ctx.lineTo(gridSize/3, gridSize/3);
                ctx.lineTo(0, gridSize/6);
                ctx.lineTo(-gridSize/3, -gridSize/3);
                ctx.lineTo(0, -gridSize/6);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
                
                // Свечение
                ctx.shadowColor = '#ff9e00';
                ctx.shadowBlur = 15;
                ctx.fillStyle = '#ff9e00';
                ctx.beginPath();
                ctx.arc(
                    speedBoost.x * gridSize + gridSize / 2,
                    speedBoost.y * gridSize + gridSize / 2,
                    gridSize / 2 + 3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            
            // Отрисовка змейки
            snake.forEach((segment, index) => {
                // Голова змейки
                if (index === 0) {
                    ctx.fillStyle = '#4cc9f0';
                    ctx.beginPath();
                    ctx.roundRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1, 4);
                    ctx.fill();
                    
                    // Глаза змейки
                    ctx.fillStyle = '#000';
                    
                    // Определяем направление для правильного расположения глаз
                    let eyeOffsetX1 = 5, eyeOffsetX2 = 11;
                    let eyeOffsetY1 = 5, eyeOffsetY2 = 5;
                    
                    if (dx === 1) { // Движение вправо
                        eyeOffsetX1 = 11; eyeOffsetX2 = 11;
                        eyeOffsetY1 = 5; eyeOffsetY2 = 11;
                    } else if (dx === -1) { // Движение влево
                        eyeOffsetX1 = 5; eyeOffsetX2 = 5;
                        eyeOffsetY1 = 5; eyeOffsetY2 = 11;
                    } else if (dy === 1) { // Движение вниз
                        eyeOffsetX1 = 5; eyeOffsetX2 = 11;
                        eyeOffsetY1 = 11; eyeOffsetY2 = 11;
                    } else if (dy === -1) { // Движение вверх
                        eyeOffsetX1 = 5; eyeOffsetX2 = 11;
                        eyeOffsetY1 = 5; eyeOffsetY2 = 5;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(
                        segment.x * gridSize + eyeOffsetX1,
                        segment.y * gridSize + eyeOffsetY1,
                        2, 0, Math.PI * 2
                    );
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.arc(
                        segment.x * gridSize + eyeOffsetX2,
                        segment.y * gridSize + eyeOffsetY2,
                        2, 0, Math.PI * 2
                    );
                    ctx.fill();
                    
                    // Язык (если движется)
                    if (dx !== 0 || dy !== 0) {
                        ctx.fillStyle = '#f72585';
                        let tongueX = segment.x * gridSize + gridSize/2;
                        let tongueY = segment.y * gridSize + gridSize/2;
                        
                        if (dx === 1) {
                            tongueX += gridSize/2;
                        } else if (dx === -1) {
                            tongueX -= gridSize/2;
                        } else if (dy === 1) {
                            tongueY += gridSize/2;
                        } else if (dy === -1) {
                            tongueY -= gridSize/2;
                        }
                        
                        ctx.beginPath();
                        ctx.arc(tongueX, tongueY, 2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } 
                // Тело змейки
                else {
                    const colorIndex = index % 3;
                    let color;
                    
                    if (colorIndex === 0) {
                        color = '#3a86ff';
                    } else if (colorIndex === 1) {
                        color = '#4361ee';
                    } else {
                        color = '#4cc9f0';
                    }
                    
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.roundRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1, 3);
                    ctx.fill();
                    
                    // Добавляем детали на тело
                    ctx.fillStyle = '#2a4fcc';
                    ctx.beginPath();
                    ctx.roundRect(
                        segment.x * gridSize + 3,
                        segment.y * gridSize + 3,
                        gridSize - 7,
                        gridSize - 7,
                        2
                    );
                    ctx.fill();
                }
            });
            
            // Отрисовка частиц
            if (particlesEnabled) {
                particles.forEach(particle => {
                    particle.draw(ctx);
                });
            }
            
            // Отрисовка эффекта замедления
            if (slowMotionActive) {
                ctx.fillStyle = 'rgba(76, 201, 240, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Текст замедления
                ctx.fillStyle = '#4cc9f0';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`ЗАМЕДЛЕНИЕ: ${Math.ceil(slowMotionTimer/30)}с`, canvas.width/2, 30);
            }
        }
        
        // Управление игрой
        function changeDirection(newDx, newDy) {
            // Запрещаем движение в противоположном направлении
            if (directionChanged) return;
            
            if ((dx === 0 && newDx !== 0) || (dy === 0 && newDy !== 0)) {
                dx = newDx;
                dy = newDy;
                directionChanged = true;
            }
        }
        
        // Инициализация системы частиц фона
        function initParticles() {
            const particlesCanvas = document.getElementById('particles');
            const particlesCtx = particlesCanvas.getContext('2d');
            
            // Устанавливаем размер canvas для частиц
            particlesCanvas.width = window.innerWidth;
            particlesCanvas.height = window.innerHeight;
            
            let bgParticles = [];
            
            // Создаем частицы фона
            for (let i = 0; i < 50; i++) {
                bgParticles.push({
                    x: Math.random() * particlesCanvas.width,
                    y: Math.random() * particlesCanvas.height,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 0.5 + 0.1,
                    color: `rgba(76, 201, 240, ${Math.random() * 0.2 + 0.1})`
                });
            }
            
            // Функция отрисовки частиц фона
            function drawParticles() {
                particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
                
                bgParticles.forEach(particle => {
                    // Обновляем позицию
                    particle.y += particle.speed;
                    if (particle.y > particlesCanvas.height) {
                        particle.y = 0;
                        particle.x = Math.random() * particlesCanvas.width;
                    }
                    
                    // Отрисовываем частицу
                    particlesCtx.fillStyle = particle.color;
                    particlesCtx.beginPath();
                    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particlesCtx.fill();
                });
                
                requestAnimationFrame(drawParticles);
            }
            
            drawParticles();
            
            // Обработка изменения размера окна
            window.addEventListener('resize', () => {
                particlesCanvas.width = window.innerWidth;
                particlesCanvas.height = window.innerHeight;
            });
        }
        
        // Обработка нажатий клавиш
        document.addEventListener('keydown', (e) => {
            if (!gameRunning && e.key !== 'Escape') return;
            
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    e.preventDefault();
                    changeDirection(0, -1);
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    // Проверяем, не зажат ли Shift для замедления
                    if (e.shiftKey) {
                        e.preventDefault();
                        activateSlowMotion();
                    } else {
                        e.preventDefault();
                        changeDirection(0, 1);
                    }
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    e.preventDefault();
                    changeDirection(-1, 0);
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    e.preventDefault();
                    changeDirection(1, 0);
                    break;
                case ' ':
                    e.preventDefault();
                    togglePause();
                    break;
                case 'p':
                case 'P':
                    e.preventDefault();
                    if (portal && portal.active) {
                        teleportSnake();
                    }
                    break;
                case 's':
                case 'S':
                    if (!e.shiftKey) break;
                    e.preventDefault();
                    activateSlowMotion();
                    break;
                case 'r':
                case 'R':
                    e.preventDefault();
                    if (confirm("Перезапустить игру?")) {
                        startGame(isClassicMode);
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    if (gameRunning) {
                        if (gamePaused) {
                            togglePause();
                        }
                        gameRunning = false;
                        clearInterval(gameLoop);
                        gameContainer.style.display = 'none';
                        mainMenu.style.display = 'flex';
                    }
                    break;
            }
        });
        
        // Обработка кнопок мобильного управления
        document.getElementById('mobile-up').addEventListener('click', () => changeDirection(0, -1));
        document.getElementById('mobile-down').addEventListener('click', () => changeDirection(0, 1));
        document.getElementById('mobile-left').addEventListener('click', () => changeDirection(-1, 0));
        document.getElementById('mobile-right').addEventListener('click', () => changeDirection(1, 0));
        document.getElementById('mobile-portal').addEventListener('click', () => {
            if (portal && portal.active) {
                teleportSnake();
            }
        });
        
        // Начало игры
        function startGame(classicMode = false) {
            initGame(classicMode);
            mainMenu.style.display = 'none';
            gameContainer.style.display = 'flex';
            gameMessage.style.display = 'none';
            
            gameRunning = true;
            gamePaused = false;
            
            updateGameSpeed();
            clearInterval(gameLoop);
            gameLoop = setInterval(gameUpdate, 1000 / gameSpeed);
            
            draw();
        }
        
        // Обновление настроек
        function updateSettings() {
            document.getElementById('speed-value').textContent = settings.speed;
            document.getElementById('difficulty-value').textContent = settings.difficulty;
            document.getElementById('speed-slider').value = settings.speed;
            document.getElementById('difficulty-slider').value = settings.difficulty;
            document.getElementById('sound-toggle').checked = settings.sound;
            document.getElementById('wall-toggle').checked = settings.wallPass;
            document.getElementById('bonus-toggle').checked = settings.bonuses;
            document.getElementById('particles-toggle').checked = settings.particles;
        }
        
        // Сохранение настроек
        function saveSettings() {
            settings.speed = parseInt(document.getElementById('speed-slider').value);
            settings.difficulty = parseInt(document.getElementById('difficulty-slider').value);
            settings.sound = document.getElementById('sound-toggle').checked;
            settings.wallPass = document.getElementById('wall-toggle').checked;
            settings.bonuses = document.getElementById('bonus-toggle').checked;
            settings.particles = document.getElementById('particles-toggle').checked;
            
            particlesEnabled = settings.particles;
            
            localStorage.setItem('snakeSettings', JSON.stringify(settings));
            
            // Закрываем модальное окно
            document.getElementById('settings-modal').style.display = 'none';
            
            // Если игра запущена, обновляем скорость
            if (gameRunning) {
                updateGameSpeed();
                clearInterval(gameLoop);
                gameLoop = setInterval(gameUpdate, 1000 / gameSpeed);
            }
        }
        
        // Очистка рекордов
        function clearHighscores() {
            if (confirm("Вы уверены, что хотите очистить таблицу рекордов?")) {
                highscores = [];
                localStorage.removeItem('snakeHighscores');
                updateHighscoresTable();
            }
        }
        
        // Инициализация при загрузке страницы
        window.onload = function() {
            // Инициализация настроек
            updateSettings();
            
            // Инициализация таблицы рекордов
            updateHighscoresTable();
            
            // Инициализация системы частиц фона
            initParticles();
            
            // Добавляем метод roundRect для Canvas, если его нет
            if (!CanvasRenderingContext2D.prototype.roundRect) {
                CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                    if (width < 2 * radius) radius = width / 2;
                    if (height < 2 * radius) radius = height / 2;
                    this.beginPath();
                    this.moveTo(x + radius, y);
                    this.arcTo(x + width, y, x + width, y + height, radius);
                    this.arcTo(x + width, y + height, x, y + height, radius);
                    this.arcTo(x, y + height, x, y, radius);
                    this.arcTo(x, y, x + width, y, radius);
                    this.closePath();
                    return this;
                }
            }
            
            // Обработчики кнопок главного меню
            document.getElementById('start-game-btn').addEventListener('click', () => startGame(false));
            document.getElementById('classic-mode-btn').addEventListener('click', () => startGame(true));
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').style.display = 'flex';
            });
            document.getElementById('highscores-btn').addEventListener('click', () => {
                document.getElementById('highscores-modal').style.display = 'flex';
            });
            document.getElementById('about-btn').addEventListener('click', () => {
                document.getElementById('about-modal').style.display = 'flex';
            });
            
            // Обработчики кнопок паузы и возобновления
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('resume-btn').addEventListener('click', () => {
                gameMessage.style.display = 'none';
                if (gameRunning) {
                    togglePause();
                }
            });
            
            // Обработчики закрытия модальных окон
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-modal').style.display = 'none';
            });
            document.getElementById('close-highscores').addEventListener('click', () => {
                document.getElementById('highscores-modal').style.display = 'none';
            });
            document.getElementById('close-about').addEventListener('click', () => {
                document.getElementById('about-modal').style.display = 'none';
            });
            
            // Обработчик сохранения настроек
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            
            // Обработчик очистки рекордов
            document.getElementById('clear-highscores').addEventListener('click', clearHighscores);
            
            // Закрытие модальных окон при клике вне их
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Первоначальная отрисовка
            draw();
            
            // Выводим информацию о еде в консоль для отладки
            console.log("Игра загружена. Еда создана на позиции:", food.x, food.y);
        };
    </script>
</body>
</html>